<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>mapCalculator</title>

    <!--<meta name="viewport" content="initial-scale=1.0, user-scalable=no">-->

    <link rel="import" href="bower_components/polymer/polymer.html">
    <link rel="import" href="bower_components/iron-demo-helpers/demo-pages-shared-styles.html">
    <link rel="import" href="bower_components/iron-demo-helpers/demo-snippet.html">
    <link rel="import" href="bower_components/paper-styles/demo-pages.html">
    <link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
    <link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
    <link rel="import" href="bower_components/paper-dropdown-menu/paper-dropdown-menu-light.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">
    <link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
    <link rel="import" href="bower_components/paper-button/paper-button.html">
    <link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="bower_components/google-map/google-map.html">
    <link rel="import" href="bower_components/google-map/google-map-poly.html">
    <link rel="import" href="bower_components/google-map/google-map-point.html">
    <link rel="import" href="bower_components/google-map/google-map-marker.html">
    <link rel="import" href="bower_components/google-map/google-map-search.html">
    <link rel="import" href="bower_components/google-map/google-map-directions.html">
    <link rel="import" href="bower_components/iron-icon/iron-icon.html">
    <link rel="import" href="bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="bower_components/paper-item/paper-item.html">
    <link rel="import" href="bower_components/paper-item/paper-icon-item.html">
    <link rel="import" href="bower_components/paper-input/paper-input.html">
    <link rel="import" href="bower_components/paper-card/paper-card.html">
    <link rel="import" href="bower_components/iron-icons/maps-icons.html">
    <link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
    <link rel="import" href="bower_components/datetime-picker/datetime-picker.html">
    <link rel="import" href="bower_components/property-mixins/range-mixin.html">
    <link rel="import" href="bower_components/property-mixins/intl-number-format-mixin.html">

    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="node_modules/@webcomponents/webcomponents-loader.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


</head>
<body>

<custom-style>
    <style is="custom-style" include="demo-pages-shared-styles">
        .main {
            margin: auto;
            width: 99%;
            background-color: #fff;
            border: 1px solid #C0C0C0;
            border-radius: 5px;
        }

        body {
            margin: 0;
        }

        .switch-button {
            max-width: 70%;
            height: 70px;
            align-items: center;
            display: table;
            padding: 0 10px;
            margin: 15px auto;
            background-color: #DCDCDC;
            border: 0.5px solid #C0C0C0;
            border-radius: 5px;
        }

        .switch-button > div {
            display: table-cell;
            vertical-align: middle;
            padding: 0 10px;
        }

        .cargo-data {
            max-height: 850px;
            overflow: auto;
            float: left;
            align-items: center;
            display: table;
            width: 29.9%;
            padding: 0 auto;
            margin: 5px auto;
            background-color: #f4f4f4;
            border: 0.5px solid #C0C0C0;
            border-radius: 5px;
        }

        .cargo-data > div {
            display: table-cell;
            vertical-align: middle;
            padding: 0 10px;
        }

        .map-data {
            float: left;
            width: 70%;
            height: 850px;
            background-color: #f4f4f4;
            border: 0.5px solid #C0C0C0;
            border-radius: 5px;
            position: relative;
        }

        /*Чтобы сделать изменяемы размер карты - раскомментировать.*/
        /*div.map-data {*/
        /*resize: both;*/
        /*overflow: auto;*/
        /*}*/
        /*google-map {*/
        /*width: 99%;*/
        /*}*/

        paper-toggle-button {
            margin-right: 10px;
        }

        paper-toggle-button.blue {
            --paper-toggle-button-checked-bar-color: var(--paper-green-500);
            --paper-toggle-button-checked-button-color: var(--paper-green-500);
            --paper-toggle-button-checked-ink-color: var(--paper-green-500);
            --paper-toggle-button-unchecked-bar-color: var(--paper-teal-500);
            --paper-toggle-button-unchecked-button-color: var(--paper-teal-500);
            --paper-toggle-button-unchecked-ink-color: var(--paper-teal-500);
        }

        .table-header {
            background-color: #dddddd;
            cursor: pointer;
        }

        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 99%;
            margin: 0 auto;
            overflow-y: auto;
            display: block;
            max-height: 810px;
        }

        td, th {
            border: 1px solid #C0C0C0;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #f5f5f5;
        }

        paper-button {
            text-align: center;
            width: 100%;
            color: white;
            background-color: green;
            margin-left: 0;
        }

        h3 {
            text-decoration: underline;
            margin: 10px auto;
        }

        .datetime {
            background-color: #f4f4f4;
        }

        .input {
            width: 100%;
            height: 100%;
        }

        .input-text {
            width: 80%;
            float: left;
        }

        .input-icon {
            width: 20%;
            float: right;
        }

        paper-icon-button.green {
            width: 85%;
            margin-top: 20px;
            margin-left: 15%;
            color: var(--paper-green-500);
            --paper-icon-button-ink-color: var(--paper-indigo-500);
        }

        paper-icon-button.green:hover {
            background-color: var(--paper-green-500);
            color: white;
        }

        paper-icon-button.green.active {
            background-color: var(--paper-red-500);
            color: white;
        }

        button#red {
            font-weight: bold;
            width: 50%;
            margin-top: 20px;
            margin-left: 15%;
            color: var(--paper-red-500);
            --paper-icon-button-ink-color: var(--paper-indigo-500);
        }

        button#red:hover {
            background-color: var(--paper-red-500);
            color: white;
        }

        button#red:active {
            background-color: var(--paper-yellow-500);
            color: white;
        }

        button#green {
            font-weight: bold;
            width: 50%;
            margin-top: 20px;
            margin-left: 15%;
            color: var(--paper-green-500);
            --paper-icon-button-ink-color: var(--paper-indigo-500);
        }

        button#green:hover {
            background-color: var(--paper-green-500);
            color: white;
        }

        button#green:active {
            background-color: var(--paper-red-500);
            color: white;
        }

        #deliveryPints {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 99%;
            margin: 0 auto;
        }

        /* Tooltip container */
        .tooltip {
            position: relative;
            float: right;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: #555;
            color: #fff;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;

            /* Position the tooltip text */
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;

            /* Fade in tooltip */
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* Tooltip arrow */
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border: 5px solid transparent;
            border-top-color: #555;
        }

        /* Show the tooltip text when you mouse over the tooltip container */
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        #popup-result {
            /*bottom: 0;*/
            max-width: 462px;
            height: 850px;
            overflow: auto;
            /*background: #d1d1d1;*/
            z-index: 98;
            position: absolute;
            top: 0;
            right: 0;
            margin: auto;
            /*float: right;*/
            /*display: none;*/
            visibility: hidden;
            opacity: 0.9;

            /*overflow: hidden;*/
            /*display: flex;*/
            /*justify-content: center;*/
            /*position: relative;*/
            /*left: 100%;*/
        }

        #popup-result.active {
            display: block;
        }

        .slide-panel {
            position: relative;
            /*margin-left: -440px;*/
            /*right: 100%;*/
            left: 400px;
            line-height: 18px;

            width: 42px;
            height: 18px;
            float: left;
            background-color: red;
            text-align: center;
        }

        .slide-panel p {
            font-size: 20px;
            margin-top: 0;
            margin-left: 3px;
            color: black;
            display: table-cell;
            vertical-align: middle;
        }

        .slide-off {
            display: none;
        }

        .slide-off:hover {
            cursor: pointer;
        }

        .slide-panel-on {
            display: none;
            line-height: 20px;
            z-index: 100;
            width: 52px;
            height: 20px;
            top: 0;
            right: 0;
            margin: auto;
            background-color: #00e676;
            text-align: center;
            position: absolute;
        }

        .slide-panel-on p {
            font-size: 20px;
            margin-top: 0;
            margin-left: 3px;
            color: black;
            display: table-cell;
            vertical-align: middle;
        }

        .slide-on {
            display: none;
        }

        .slide-on:hover {
            cursor: pointer;
        }

        .content {
            position: relative;
            width: 400px;
            height: 850px;
            background: #d1d1d1;
            float: right;
            left: 442px;
            overflow: auto;

        }

        #image {
            height: 100px;
            width: 100px;
            visibility: hidden;
            z-index: 100;
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            margin: auto;
        }

        #bg_popup-result {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 99;
            background: rgba(0, 0, 0, .2);
            visibility: hidden;
        }

        #car-category {
            float: right;
            width: 33.333%;
        }

        .both {
            clear: both;
        }

        .display_none {
            display: none;
        }

        .float_left {
            float: left;
        }

        .float_right {
            float: right;
        }

        .input_color {
            background: #d9d9d9;
            padding: 12px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .input-symbol-currency {
            position: relative;
        }

        .input-symbol-currency input {
            /*padding-left:35px;*/
        }

        .input-symbol-currency:before {
            position: absolute;
            top: 0;
            content: "UAH";
            left: 80%;
            float: right;

        }

        /*fieldset {*/
        /*border: 1px solid #339dc7;*/
        /*!* Чтобы подстраивался под контент *!*/
        /*display: inline-block;*/
        /*}*/
    </style>
</custom-style>

<div class="main">
    <div style="width: 100%; text-align:center;">
        <div class="tooltip" style="float: left; width: 33.333%">
            <div class="switch-button centered">
                <div class="switch" style="padding-right: 0">
                    <p>Оптимизированный
                    </p>
                </div>
                <div>
                    <paper-toggle-button class="blue" disabled>Ручная оптимизация
                        <span class="tooltiptext">Данная функция доступна в платной версии</span>
                    </paper-toggle-button>
                </div>
            </div>

        </div>
        <div style="margin: 0 auto; width: 33.333%; display: inline-block;">
            <div class="switch-button centered">
                <div class="switch" style="padding-right: 0">
                    <p>Городская доставка</p>
                </div>
                <div>
                    <paper-toggle-button class="blue">Магистраль</paper-toggle-button>
                </div>
            </div>
        </div>
        <div id="car-category">
            <div class="switch-button centered" id="switch-button">
                <!--<paper-dropdown-menu-light label="Категория машины">-->
                <!--<paper-listbox id="paper-listbox" slot="dropdown-content" class="dropdown-content">-->
                <!--<template id="list" is="dom-repeat" items="{{arr}}">-->
                <!--<paper-item>[[item.name]]</paper-item>-->
                <!--</template>-->
                <!--</paper-listbox>-->
                <!--</paper-dropdown-menu-light>-->
            </div>
        </div>
    </div>
    <template is="dom-bind">
        <div style="width: 100%">
            <div class="cargo-data">
                <div style="width: 85%">

                    <table id="deliveryPints">
                        <tr class="table-header">
                            <td>Адрес доставки по маршруту</td>
                            <td>Служебное время</td>
                            <td>Правка доставки</td>
                        </tr>
                        <tr>
                            <td>
                                <div class="input">
                                    <div class="input-text">
                                        <paper-input id="delAddress" type='text' placeholder="Адрес погрузки"
                                                     value="{{delivery}}"></paper-input>
                                    </div>
                                    <div class="input-icon">
                                        <paper-icon-button class='green' id="firstBtn" icon="room" alt="Отметить"
                                                           title="Отметить"></paper-icon-button>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <paper-input placeholder="время" type="time" id="delTime"
                                             value="01:00"></paper-input>
                            </td>
                            <td>
                                <button class='AddNew' id="green">+</button>
                            </td>
                        </tr>
                    </table>

                    <paper-button id="countJ" class="count" raised onClick="countJourney()" data-toggle="modal"
                                  data-target="#myModal">Расчитать
                    </paper-button>
                </div>
            </div>



            <div class="map-data" id="map-data">
                <div class="slide-panel-on">
                <p class="slide-on"><<<</p>
                </div>
                <google-map map="{{map}}" latitude="50.45466" longitude="30.5238000" zoom="10" click-events="true"
                            mouse-events="true"
                            api-key="AIzaSyAzfbw6SKbft4KSyi0gzmO08YPfMVlcOwM" disable-default-ui>
                </google-map>
                <div class="popup-result" id="popup-result">
                    <div class="slide-panel">
                        <p class="slide-off">>>></p>

                        <!--<input type="button" value="shower">-->
                    </div>
                    <div class="content">
                        <div class="both">
                            <fieldset>
                                <legend>
                                    <h3 style="text-align: center; float: left">По всему маршруту</h3>
                                    <input type="button" id="myDivBtn" style="float: right; margin-top: 8px"
                                           onclick="showDiv('myDiv')" value="+">
                                    <!--<button onclick="showDiv('myDiv')" style="float: right; margin-top: 8px">+</button>-->
                                </legend>
                                <div id="myDiv" class="both display_none">
                                    <div class="float_left">
                                        <a>Время погрузки, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Время разгрузки, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Время пути, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Суммарное время, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Доп.время, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Дист. в пути, км</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Дист. возврата, км</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Стоимость въезда</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость подачи</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                    </div>

                                    <div class="float_right">
                                        <a>Стоимость погрузки</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость разгрузки</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость вмемени в пути</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>

                                        <a>Общая стоимость времени</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость доп.времени</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость дистанции</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость возврата</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость выезда</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Суммарная стоимость</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                        <div class="both">
                            <fieldset>
                                <legend>
                                    <h3 style="text-align: center; float: left">Polygon</h3>
                                    <input type="button" id="myDiv2Btn" style="float: right; margin-top: 8px"
                                           onclick="showDiv('myDiv2')" value="+">

                                    <!--<button onclick="showDiv('myDiv2')" style="float: right; margin-top: 8px">+</button>-->
                                </legend>
                                <div id="myDiv2" class="both display_none">
                                    <div class="float_left">
                                        <a>Время погрузки, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Время разгрузки, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Время пути, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Суммарное время, м</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Дист. в пути, км</a>
                                        <div>
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </div>
                                        <a>Стоимость въезда</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                    </div>

                                    <div class="float_right">
                                        <a>Стоимость погрузки</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость разгрузки</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость вмемени в пути</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>

                                        <a>Общая стоимость времени</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость дистанции</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Стоимость выезда</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                        <a>Суммарная стоимость</a>
                                        <div>
                                        <span class="input-symbol-currency">
                                            <input type="text" readonly="readonly" value="0" class="input_color">
                                        </span>
                                        </div>
                                    </div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>
                <!--<div class="bg_popup-result"></div>-->
            </div>
        </div>
        <div id="image">
            <img src="http://planarry.com/img/loader.gif">
        </div>
        <div id="bg_popup-result"></div>
        <script>

            let firstJourneyPoint = null;
            let correctMarkerLengthIndex = 0;
            let arrayMarkers = Array();
            var firstDelPointIndex = 1;
            let clientAndSecret = btoa('admin:admin');
            let userLogin = 'admin';
            let userPassword = 'admin';
            let oauthToken = null;
            let myTable = document.getElementById("deliveryPints");
            let map = document.querySelector('google-map');
            let countedJourney = false;
            let addressByCoordinates = null;
            let jsonAnswerCarCategory;

            map.addEventListener('google-map-click', function (e) {
                let bool = false;
                let latLng = e.detail.latLng;
                let lat = latLng.lat().toFixed(3) * 1;
                let lng = latLng.lng().toFixed(3) * 1;
                if (firstDelPointIndex === 0) {
                    createRowInTable();
                }
                beforeCreateMarker(lat, lng, bool);
                setClassGreenNotActive();
            });

            map.addEventListener('zoom-changed', function () {
                map.setAttribute('zoom', map.zoom);
            });

            function setClassGreenNotActive() {
                let allDelIcons = document.getElementsByClassName('green');
                Array.prototype.forEach.call(allDelIcons, function (elem) {
                    elem.setAttribute('class', elem.getAttribute('class').replace(' active', ''));
                });
            }

            function beforeCreateMarker(lat, lng, bool) {

                if (firstDelPointIndex !== 0) {
                    let delId = 'delAddress';
                    if (firstDelPointIndex > 1) {
                        delId = delId + firstDelPointIndex;
                    }
                    let id = 'marker' + firstDelPointIndex;
                    let createdMarker = document.getElementById(id);
                    if (createdMarker === null) {
                        let delMarker = createMarker(lat, lng, delId, bool);
                        delMarker.setAttribute('id', id);

                        if (delId === 'delAddress') {
                            firstJourneyPoint = delMarker;
                            Polymer.dom(map).appendChild(firstJourneyPoint);
                        } else {
                            arrayMarkers[firstDelPointIndex] = delMarker;
                            Polymer.dom(map).appendChild(delMarker);
                        }
                    } else {
                        changePointCoordinates(lat, lng, createdMarker, delId, bool);
                    }
                }
                firstDelPointIndex = 0;

            }

            function createMarker(lat, lng, id, bool) {
                let marker = document.createElement('google-map-marker');
                marker.setAttribute('latitude', lat);
                marker.setAttribute('longitude', lng);
                marker.setAttribute('title', "Dynamic title");
                marker.setAttribute('draggable', true);
                marker.setAttribute('click-events', true);
                marker.setAttribute('mouse-events', true);
                marker.setAttribute('drag-events', true);
                if (id === 'delAddress') {
                    marker.setAttribute('icon', "http://maps.google.com/mapfiles/ms/icons/green-dot.png");
                } else {
                    marker.setAttribute('icon', "http://maps.google.com/mapfiles/ms/icons/blue-dot.png")
                }
                addListenerOnMarker(marker, id, lat, lng, bool);
                correctMarkerLengthIndex++;
                return marker;
            }

            function addListenerOnMarker(marker, id, lat, lng, bool) {
                let index = firstDelPointIndex;
                let input = document.getElementById(id);
                if (bool !== true) {
                    getAddressByCoordinates(lat, lng, input, index);
                }

                if (marker != null) {
                    marker.addEventListener('google-map-marker-dragend', function (e1) {
                        let lat = e1.detail.latLng.lat().toFixed(3) * 1;
                        let lng = e1.detail.latLng.lng().toFixed(3) * 1;
                        // console.log(lat + "; " + lng);
                        marker.setAttribute('latitude', lat);
                        marker.setAttribute('longitude', lng);
                        getAddressByCoordinates(lat, lng, input, index);
                    });

                    marker.addEventListener('google-map-marker-dblclick', function () {
                        Polymer.dom(map).removeChild(marker);
                        input.value = null;
                        marker = null;
                        if (id === 'delAddress') {
                            firstJourneyPoint = marker;
                            firstDelPointIndex = 0;
                        } else {
                            delete arrayMarkers[index];
                            document.getElementById('row' + index).style.display = "none";
                            firstDelPointIndex = 0;
                            correctMarkerLengthIndex--;
                        }
                    });
                }
            }

            function changePointCoordinates(lat, lng, marker, id, bool) {
                marker.setAttribute('latitude', lat);
                marker.setAttribute('longitude', lng);
                let input = document.getElementById(id);
                let index = firstDelPointIndex;
                if (bool !== true) {
                    getAddressByCoordinates(lat, lng, input, index);
                }
            }

            let addIconBtn = document.getElementById("firstBtn");
            addIconBtn.addEventListener('click', createActiveChangedPointIcon);

            let addDelAddress = document.getElementById("delAddress");
            addDelAddress.addEventListener('click', function () {

                firstDelPointIndex = 1;
                createActiveChangedPointIcon();
            });
            addDelAddress.addEventListener('change', function () {
                let index = 1;
                getAddressByShortName(addDelAddress.value, addDelAddress, index);
                createActiveChangedPointIcon();
            });

            let addBtn = document.querySelector(".AddNew");
            addBtn.addEventListener('click', createRowInTable);

            function createActiveChangedPointIcon() {
                let str = addIconBtn.getAttribute('class');
                if (str.includes('active')) {
                    addIconBtn.setAttribute('class', str.replace(' active', ''));
                    firstDelPointIndex = 0;
                } else {
                    let allDelIcons = document.getElementsByClassName('green');
                    Array.prototype.forEach.call(allDelIcons, function (elem) {
                        elem.setAttribute('class', elem.getAttribute('class').replace(' active', ''));
                    });

                    addIconBtn.setAttribute('class', addIconBtn.getAttribute('class') + " active");
                    firstDelPointIndex = 1;
                }
            }

            function createRowInTable() {
                let currentIndex = myTable.rows.length;
                firstDelPointIndex = currentIndex;
                let currentRow = myTable.insertRow(-1);

                currentRow.setAttribute('id', 'row' + currentIndex);


                let divInput = document.createElement('div');
                divInput.setAttribute('class', 'input');

                let divInputText = document.createElement('div');
                divInputText.setAttribute('class', 'input-text');

                let divInputIcon = document.createElement('div');
                divInputIcon.setAttribute('class', 'input-icon');

                let delAddress = document.createElement('paper-input');
                delAddress.setAttribute('type', 'text');
                delAddress.setAttribute('placeholder', 'адрес' + currentIndex);
                delAddress.setAttribute('id', 'delAddress' + currentIndex);
                // delAddress.setAttribute('value', 'delivery' + currentIndex);

                let delIcon = document.createElement('paper-icon-button');
                delIcon.setAttribute('class', 'green');
                delIcon.setAttribute('icon', 'room');
                delIcon.setAttribute('alt', 'Отметить');
                delIcon.setAttribute('onClick', '');
                delIcon.setAttribute('title', 'Отметить');

                divInputText.appendChild(delAddress);
                divInputIcon.appendChild(delIcon);

                divInput.appendChild(divInputText);
                divInput.appendChild(divInputIcon);

                let delTime = document.createElement('paper-input');
                delTime.setAttribute('type', 'time');
                delTime.setAttribute('value', '01:00');
                delTime.setAttribute('placeholder', 'min' + currentIndex);
                delTime.setAttribute('id', 'delTime' + currentIndex);

                let delBtn = document.createElement('button');
                delBtn.setAttribute('class', 'removeRow');
                delBtn.setAttribute('id', 'red');
                Polymer.dom(delBtn).innerHTML = "-";

                let currentCell = currentRow.insertCell(-1);
                currentCell.appendChild(divInput);
                currentCell = currentRow.insertCell(-1);
                currentCell.appendChild(delTime);
                currentCell = currentRow.insertCell(-1);
                currentCell.appendChild(delBtn);

                delAddress.addEventListener('click', function () {
                    firstDelPointIndex = currentIndex;
                    createActiveChangedPointIcon();
                });

                delAddress.addEventListener('change', function () {
                    getAddressByShortName(delAddress.value, delAddress, currentIndex);
                    createActiveChangedPointIcon();

                });

                delBtn.addEventListener('click', function () {
                    let id = 'marker' + currentIndex;
                    let deleteMarker = document.getElementById(id);
                    if (deleteMarker !== null) {
                        // arrayMarkers.splice(currentIndex, 1);
                        delete arrayMarkers[currentIndex];

                        Polymer.dom(map).removeChild(deleteMarker);
                        firstDelPointIndex = 0;
                        deleteMarker = null;
                        correctMarkerLengthIndex--;
                    }
                    // myTable.deleteRow(currentIndex);
                    document.getElementById('row' + currentIndex).style.display = "none";

                });

                delIcon.addEventListener('click', createActiveChangedPointIcon);

                function createActiveChangedPointIcon() {
                    let str = delIcon.getAttribute('class');
                    if (str.includes('active')) {
                        delIcon.setAttribute('class', str.replace(' active', ''));
                        firstDelPointIndex = 0;
                    } else {
                        let allDelIcons = document.getElementsByClassName('green');
                        Array.prototype.forEach.call(allDelIcons, function (elem) {
                            elem.setAttribute('class', elem.getAttribute('class').replace(' active', ''));
                        });

                        delIcon.setAttribute('class', delIcon.getAttribute('class') + " active");
                        firstDelPointIndex = currentIndex;

                    }
                }
            }

            function countJourney() {
                clearAllPoly();
                if (arrayMarkers.length < 1 || firstJourneyPoint === null || correctMarkerLengthIndex < 2) {
                    alert("Необходимо заполнить точку Старта и разгрузки");
                } else {
                    document.getElementById('image').style.visibility = 'visible';
                    document.getElementById('bg_popup-result').style.visibility = 'visible';
                    countedJourney = true;
                    arrayMarkers.splice(0, 0, firstJourneyPoint);
                    let pointsCoordinates = Array();

                    arrayMarkers.forEach(function (marker) {
                        let pointStr = marker.getAttribute('longitude') + "," + marker.getAttribute('latitude');
                        pointsCoordinates.push(pointStr);
                    });
                    getRoute(pointsCoordinates);
                    parseDataFromRequestCarCategory();
                    calculateJourney();
                    arrayMarkers.splice(0, 1);
                }
            }

            function calculateJourney() {
                let jsonForRequestCalculator = {
                    points: [],
                    times: [],
                    category: String
                };
                arrayMarkers.forEach(function (marker) {
                    jsonForRequestCalculator.points.push({
                        'latitude': marker.getAttribute('latitude'),
                        'longitude': marker.getAttribute('longitude')
                    });
                });
                jsonForRequestCalculator.times.push({
                    'time': document.querySelector('#delTime').value
            });
                for (let i = 1; i < arrayMarkers.length; i++) {
                    if (typeof arrayMarkers[i] !== "undefined") {
                        let id = '#delTime' + (i-1);
                        jsonForRequestCalculator.times.push({
                            'time': document.querySelector(id).value
                        });
                    }
                }
                let dropdown = document.querySelector('paper-dropdown-menu-light');
                jsonForRequestCalculator.category = dropdown.selectedItem.id;

                let json = JSON.stringify(jsonForRequestCalculator);
                // console.log(JSON.stringify(jsonForRequestCalculator));
                getCalculatedJourney(json);
            }

            function clearAllPoly() {
                let oldPoly = document.querySelector('google-map-poly');
                if (oldPoly !== null) {
                    Polymer.dom(map).removeChild(oldPoly);
                    oldPoly = null;
                    clearAllPoly();
                }
            }

            function parseDataFromRequestCarCategory() {
                let dropdown = document.querySelector('paper-dropdown-menu-light');
                let selectedCategoryId = dropdown.selectedItem.id;
                for (let i = 0; i < jsonAnswerCarCategory.length; i++) {
                    if (selectedCategoryId === jsonAnswerCarCategory[i]['id']) {
                        let areas = jsonAnswerCarCategory[i]['areas'];
                        for (let j = 0; j < areas.length; j++) {
                            let polygonPoints = areas[j]['polygon']['polygonPoint'];
                            if (polygonPoints !== null) {
                                let color = areas[j]['polygon']['color'];
                                let poly = createPolygonOnMap(polygonPoints);
                                if (color !== "" && typeof color !== "undefined") {
                                    poly.setAttribute('fill-color', areas[j]['polygon']['color']);
                                }
                                // console.log(color.length);
                                Polymer.dom(map).appendChild(poly);
                            }
                        }
                    }
                }
            }

            function createPolygonOnMap(polygonPoints) {
                let poly = document.createElement('google-map-poly');
                poly.setAttribute('stroke-color', '#FF0000');
                poly.setAttribute('stroke-opacity', '0.8');
                poly.setAttribute('stroke-weight', '2');
                poly.setAttribute('fill-color', "#FF0000");
                poly.setAttribute('fill-opacity', '0.35');
                poly.setAttribute('closed', true);
                polygonPoints.forEach(function (point) {
                    let polyPoint = document.createElement('google-map-point');
                    polyPoint.setAttribute('latitude', point['lat']);
                    polyPoint.setAttribute('longitude', point['lon']);
                    Polymer.dom(poly).appendChild(polyPoint);
                });
                return poly;
            }

            function getRoute(list) {
                let urlStr = "http://planarry.com/map/route/v1/driving/" + list.join(';');
                let urlRes = new URL(urlStr);
                urlRes.searchParams.append('overview', 'full');
                urlRes.searchParams.append('geometries', 'geojson');
                urlRes.searchParams.append('steps', true);
                try {
                    // console.log("My result: " + urlRes);
                    doRequest(urlRes);
                } catch (e) {
                    console.log(e.message);
                }
            }

            function doRequest(url) {
                let jsonResponse = 'empty';
                let httpRequest = new XMLHttpRequest();
                httpRequest.open("GET", url, true);

                httpRequest.onreadystatechange = function () {
                    if (httpRequest.status >= 200 && httpRequest.status < 300) {
                        jsonResponse = httpRequest.responseText;
                    } else if (httpRequest.responseText === null) {
                        jsonResponse = "Loss connection to route server";
                    } else {
                        jsonResponse = "Answer from route server " + httpRequest.status;
                    }
                    let coordinates = parseRouteTrack(jsonResponse);
                    let poly = createPolyByRouteJson(coordinates);
                    Polymer.dom(map).appendChild(poly);

                    document.getElementById("image").style.visibility = "hidden";
                    document.getElementById("bg_popup-result").style.visibility = "hidden";
                    document.getElementById("popup-result").style.visibility = 'visible';

                };
                httpRequest.send(null);
                // console.log("My status: " + httpRequest.status);


            }

            function parseRouteTrack(jsonResponse) {
                let json = JSON.parse(jsonResponse);
                if (json.hasOwnProperty('routes')) {
                    let jsonRoutes = json['routes'];
                    if (jsonRoutes.length > 0) {
                        let firstArray = jsonRoutes[0];
                        let geometry = firstArray['geometry'];
                        return geometry['coordinates'];
                    }
                }
            }

            function createPolyByRouteJson(coordinatesJson) {
                let poly = document.createElement('google-map-poly');
                poly.setAttribute('fill-color', '#FFF');

                poly.setAttribute('stroke-color', '#4682B4');
                poly.setAttribute('fill-opacity', '.5');
                coordinatesJson.forEach(function (point) {
                    let polyPoint = document.createElement('google-map-point');
                    polyPoint.setAttribute('latitude', point[1]);
                    polyPoint.setAttribute('longitude', point[0]);
                    Polymer.dom(poly).appendChild(polyPoint);
                });
                return poly;
            }

            // function getCalculatedJourney(json) {
            //     console.log(json);
            //
            //     $.post({
            //         url: 'http://localhost:8080/erp/rest/v2/services/erp_CalculatorService/calculateTrafficFromWebRequest',
            //         headers: {
            //             'Authorization': 'Bearer ' + oauthToken,
            //             'Content-Type': 'application/x-www-form-urlencoded'
            //         },
            //          dataType: 'json',
            //          data: {jsonRequest: json},
            //         success: function (data) {
            //             console.log("data: " + data);
            //         }
            //     })
            // }

            function getCalculatedJourney(json) {
                let changedJson = json.replace(/{/g, '(')
                    .replace(/}/g, ')');
                console.log(changedJson);

                $.get({
                    url: 'http://localhost:8080/erp/rest/v2/services/erp_CalculatorService/calculateTrafficFromWebRequest?jsonRequest=' + changedJson,
                    headers: {
                        'Authorization': 'Bearer ' + oauthToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    // dataType: 'json',
                    // data: {jsonRequest: json},
                    success: function (data) {
                        console.log("data: " + data);
                    }
                })
            }

            window.onload = function () {
                getOAuthToken();
            };

            function getOAuthToken() {
                $.post({
                    url: 'http://localhost:8080/erp/rest/v2/oauth/token',
                    headers: {
                        'Authorization': 'Basic ' + clientAndSecret,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    dataType: 'json',
                    data: {grant_type: 'password', username: userLogin, password: userPassword},
                    success: function (data) {
                        oauthToken = data.access_token;
                        getCarCategories();
                    }
                });
            }

            function getCarCategories() {
                $.get({
                    url: 'http://localhost:8080/erp/rest/v2/entities/erp$Category?view=category-view',
                    headers: {
                        'Authorization': 'Bearer ' + oauthToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    success: function (data) {
                        let switchDiv = document.getElementById('switch-button');

                        let dropdown = document.createElement('paper-dropdown-menu-light');
                        dropdown.setAttribute('label', 'Категория машины');

                        let listBox = document.createElement('paper-listbox');
                        listBox.setAttribute('slot', 'dropdown-content');
                        listBox.setAttribute('class', 'dropdown-content');
                        listBox.setAttribute('selected', 0);

                        $.each(data, function (i, category) {
                            let paperItem = document.createElement('paper-item');
                            paperItem.setAttribute('id', category.id);
                            Polymer.dom(paperItem).innerHTML = category.name;
                            Polymer.dom(listBox).appendChild(paperItem);
                        });
                        Polymer.dom(dropdown).appendChild(listBox);
                        Polymer.dom(switchDiv).appendChild(dropdown);

                        jsonAnswerCarCategory = data;
                    }
                });
            }

            function getAddressByCoordinates(lat, lng, input, index) {
                $.get({
                    url: 'http://localhost:8080/erp/rest/v2/services/erp_GeocodingService/findAddressByCoordinates?lat=' + lat + '&lng=' + lng,
                    headers: {
                        'Authorization': 'Bearer ' + oauthToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    success: function (data) {
                        // console.log(data);

                        parseAddressJson(data, input, index, lat, lng);
                    }
                });
            }

            function getAddressByShortName(address, addDelAddress, index) {
                $.get({
                    url: 'http://localhost:8080/erp/rest/v2/services/erp_GeocodingService/findAddressByShirtAddress?address=' + address,
                    headers: {
                        'Authorization': 'Bearer ' + oauthToken,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    success: function (data) {
                        // console.log(data);

                        parseAddressJson(data, addDelAddress, index, 0, 0);
                    }
                });
            }

            function parseAddressJson(json, input, index, lat, lng) {
                addressByCoordinates = null;
                let zoom = map.getAttribute('zoom');

                let response = JSON.parse(json);
                if (response.hasOwnProperty('status')) {
                    let status = response['status'];
                    switch (status) {
                        case 'OK':
                            let resultArr = response['results'];
                            for (let i = 0; i < resultArr.length; i++) {
                                let address = '';
                                let componentsArray = resultArr[i]['address_components'];
                                for (let j = componentsArray.length - 1; j >= 0; j--) {
                                    let component = componentsArray[j];
                                    let types = component['types'];
                                    for (let k = 0; k < types.length; k++) {

                                        switch (types[k]) {
                                            case 'country':
                                                address = component['long_name'];
                                                break;
                                            case 'locality':
                                                if (zoom >= 10) {
                                                    address = address + ", " + component['long_name'];
                                                }
                                                break;
                                            case 'route':
                                                if (zoom >= 14) {
                                                    address = address + ", " + component['long_name'];
                                                }
                                                break;
                                            case 'street_number':
                                                if (zoom >= 17) {
                                                    address = address + ", " + component['long_name'];
                                                }
                                                break;
                                        }
                                    }
                                }
                                addressByCoordinates = address;

                                if (lat === 0 && lng === 0) {
                                    let locationObj = resultArr[i]['geometry']['location'];
                                    firstDelPointIndex = index;
                                    let bool = true;
                                    beforeCreateMarker(locationObj['lat'].toFixed(3), locationObj['lng'].toFixed(3), bool);
                                }
                                break;
                            }
                            break;
                        case 'OVER_QUERY_LIMIT':
                            alert('Превышена квота для запросов к Google API');
                            // console.log(json);
                            break;
                        case 'ZERO_RESULTS':
                            // alert('Адрес не найден');
                            // console.log(json);
                            break;
                        default:
                            alert('Ошибка поиска адреса');
                            // console.log(json);
                            break;
                    }
                }
                if (addressByCoordinates !== null) {
                    input.value = addressByCoordinates;
                } else {
                    input.value = lat + "; " + lng;
                }
            }

            function showDiv(id) {
                let e = document.getElementById(id);
                let btn = document.getElementById(id + 'Btn');
                if (e.style.display == 'block') {
                    e.style.display = 'none';
                    btn.value = '+';
                }
                else {
                    e.style.display = 'block';
                    btn.value = '-';
                }
            }
        </script>
        <script>

            $('#countJ').on('click', function () {
                $('.content').css({left: "100%"}).animate({left:"0"}, 400);
                $('.slide-off').css({display: "block"});
                $('.slide-panel').css({left: "100%"}).animate({left: "0"}, 400);
            });
            $('.slide-on').on('click', function () {
                $('.content').css({left: "97%"}).animate({left:"0%"}, 400);
                $('.slide-on').css({display: 'none'});
                $('.slide-panel-on').css({display: 'none'});
                $('.slide-off').css({display: 'block'});
                $('.slide-panel').css({left: '97%'}).animate({left: '0%'}, 400);
                $('#popup-result').css({display: 'block'});
            });
            $('.slide-off').on('click', function () {
                $('.content').css({left: "3%"}).animate({left:"90%"}, 400);
                $('.slide-off').css({display: 'none'});
                $('.slide-on').css({display: 'block'});
                $('.slide-panel-on').css({display: 'block'});
                $('.slide-panel').css({left: '3%'}).animate({left: '90%'}, 400);
                setTimeout(function () {
                    $('#popup-result').css({display: 'none'});
                }, 300);
            });
        </script>
    </template>
</div>
</body>
</html>